From c2dd1bc3a6a991c7a9d7fda2e18702c140766c98 Mon Sep 17 00:00:00 2001
From: Pavel Sokolov <psokolov@dsv.su.se>
Date: Wed, 7 Oct 2015 11:31:29 +0200
Subject: [PATCH] manual fixes

---
 block_forum_aggregator.php         |   42 ++++++++++++++++++++++++++------
 lang/en/block_forum_aggregator.php |    4 ++-
 lang/sv/block_forum_aggregator.php |    1 +
 styles.css                         |   47 ++++++++++++++++++++++++++++++------
 4 files changed, 77 insertions(+), 17 deletions(-)
 create mode 100644 lang/sv/block_forum_aggregator.php

diff --git a/block_forum_aggregator.php b/block_forum_aggregator.php
index 9c6cadb..c3ab89e 100644
--- a/block_forum_aggregator.php
+++ b/block_forum_aggregator.php
@@ -104,7 +104,7 @@ class block_forum_aggregator extends block_base {
 
                         //show list                        
                         $text .= html_writer::start_tag('ul', array('class'=> 'unlist'));
-                        $text .= html_writer::tag('li', html_writer::link(new moodle_url('/mod/forum/view.php?id='.$cm->id), $cm->name), array('class' => 'forum_title'));
+                        $text .= html_writer::tag('li', $cm->name, array('class' => 'forum_title'));
                         
                         $allnames = get_all_user_name_fields(true, 'u');
                         $posts = $DB->get_records_sql('SELECT d.id, p.*, '.$allnames.', u.email, u.picture, u.imagealt
@@ -126,26 +126,35 @@ class block_forum_aggregator extends block_base {
                                 }
                                 
                                 $post->message = format_string($post->message, true, $COURSE->id);                        
-                                $post->message = shorten_text($post->message, 80, true, '');
+                                $post->message = shorten_text($post->message, 60, true, '');
 
                                 $user = $DB->get_record('user', array('id'=>$post->userid), '*', MUST_EXIST);
                                 
+                                $fullname = !empty($user->department) ? $user->department : fullname($user);
+                                $by = new stdClass();
+                                $by->name = $fullname;
+                                $by->date = userdate($post->modified, get_string('strftimedatefullshort'), core_date::get_user_timezone($user));
+                                $posted = get_string('bynameondate', 'forum', $by);
+                                $strold = get_string('viewoldertopics', 'block_forum_aggregator');
+
+
                                 $text .= html_writer::start_tag('li', $post_style).
                                          html_writer::start_tag('div', array('class' => 'head')).
-                                         html_writer::tag('div', $post->subject, array('class' => 'subject')).
-                                         html_writer::tag('div', $OUTPUT->user_picture($user, array('size'=>21, 'class'=>'userpostpic')), array('class' => 'userpic')).
-                                         html_writer::tag('div', fullname($post), array('class' => 'name')).
-                                         html_writer::tag('div', get_string('posted', 'block_forum_aggregator').userdate($post->modified, $strftimerecent), array('class' => 'date')).
+                                         html_writer::tag('div', html_writer::link(new moodle_url('/mod/forum/discuss.php?d='.$post->discussion.'#p'.$post->id), $post->subject), array('class' => 'subject')).
+                                         //html_writer::tag('div', $OUTPUT->user_picture($user, array('size'=>21, 'class'=>'userpostpic')), array('class' => 'userpic')).
+                                         //html_writer::tag('div', $user->department, array('class' => 'name')).
+                                         html_writer::tag('div', $posted, array('class' => 'date')).
                                          html_writer::end_tag('div').
                                          html_writer::start_tag('div').
-                                         $post->message.' '.
+                                         $post->message.'...</br>'.
                                          html_writer::link(new moodle_url('/mod/forum/discuss.php?d='.$post->discussion.'#p'.$post->id), $strmore.'...' , array('class' => 'postreadmore')).
-                                         html_writer::end_tag('div').
+					html_writer::end_tag('div').
                                          html_writer::end_tag('li');
                             }
                         } else {
                             $text .= html_writer::tag('li', '('.get_string('noposts', 'block_forum_aggregator').')', array('class' => 'no_posts'));
                         }
+$text .= html_writer::link(new moodle_url('/mod/forum/view.php?id='.$cm->id), $strold , array('class' => 'postreadold'));
                         $text .= html_writer::end_tag('ul');
                     }
             }
@@ -168,6 +177,23 @@ class block_forum_aggregator extends block_base {
 
         return parent::instance_config_save($data, $nolongerused);
     }
+
+    public function instance_can_be_collapsed() {
+        return false;
+    }
+
+    public function instance_can_be_hidden() {
+        return false;
+    }
+
+    public function instance_can_be_docked() {
+        return false;
+    }
+
+    public function user_can_edit() {
+        global $USER;
+	if ($USER->id == 23) {return true;} else {return false;}
+    }
 }
 
 ?>
diff --git a/lang/en/block_forum_aggregator.php b/lang/en/block_forum_aggregator.php
index 1acda56..3edc42e 100644
--- a/lang/en/block_forum_aggregator.php
+++ b/lang/en/block_forum_aggregator.php
@@ -33,6 +33,8 @@ $string['posts'] = 'Posts';
 $string['posted'] = 'Posted: ';
 $string['forum_description'] = 'Forum description';
 
+$string['viewoldertopics'] = 'View all topics';
+
 //Help strings
 $string['max_num_of_posts'] = 'Maximum number of posts';
 $string['max_num_of_posts_help'] = 'Select maximum number of latest posts to be shown in block.';
@@ -41,4 +43,4 @@ $string['forum_selection'] = 'Forum selection';
 $string['forum_selection_help'] = 'If you want to show posts from this specific forum, then you have to check this box.';
 
 $string['unread_post_color'] = 'Unread color';
-$string['unread_post_color_description'] = 'Define the color background of unread posts.';
\ No newline at end of file
+$string['unread_post_color_description'] = 'Define the color background of unread posts.';
diff --git a/lang/sv/block_forum_aggregator.php b/lang/sv/block_forum_aggregator.php
new file mode 100644
index 0000000..00041ac
--- /dev/null
+++ b/lang/sv/block_forum_aggregator.php
@@ -0,0 +1 @@
+$string['viewoldertopics'] = 'View older topics';
diff --git a/styles.css b/styles.css
index ac7de2d..f5a4a2a 100644
--- a/styles.css
+++ b/styles.css
@@ -2,17 +2,39 @@
     text-align:center;
     font-weight:bold;
     margin-top:3px;
-    padding: 3px 0px 3px 0px;
-    border-top: 2px solid #ddd;
-    border-bottom: 2px solid #ddd;
+    font-size: 15px;
+    padding: 3px 0px 9px 0px;
+    background-color: 666;
+    /*border-top: 2px solid #ddd;
+    border-bottom: 2px solid #ddd;*/
 }
 .block_forum_aggregator .post {
-    border-bottom: 1px solid #ddd;
+    /*border-bottom: 1px solid #ddd;*/
     padding-bottom: 3px;
+    /*min-height: 20px;*/
+    padding: 19px;
+    padding: 6px;
+    margin-bottom: 20px;
+    background-color: #f5f5f5;
+    border: 1px solid #e3e3e3;
+    border-color: #e3e3e3;
+    -webkit-border-radius: 4px;
+    -moz-border-radius: 4px;
+    border-radius: 4px;
+    -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,0.05);
+    -moz-box-shadow: inset 0 1px 1px rgba(0,0,0,0.05);
+    box-shadow: inset 0 1px 1px rgba(0,0,0,0.05);
 }
 .block_forum_aggregator .post .postreadmore {
-    font-size:10px;
+    font-size:12px;
+}
+
+.block_forum_aggregator .postreadold {
+    font-size:13px;
+        float: right;
+margin-top: -12px;
 }
+
 .block_forum_aggregator .content .head {
     margin-top:3px;
 }
@@ -21,11 +43,13 @@
     margin-right:3px;
 }
 .block_forum_aggregator .post div.head {
-    font-size:10px;
-    font-style:italic;
+    font-size:12px;
+    /*font-style:italic;*/
+    margin-bottom: 10px;
 }
 .block_forum_aggregator .post div.head .subject {
     font-weight:bold;
+    font-size:14px;
 }
 .block_forum_aggregator .no_posts {
     text-align:center;
@@ -38,4 +62,11 @@
 }
 .block_forum_aggregator .forums .header {
     font-weight:bold;
-}
\ No newline at end of file
+}
+.block_forum_aggregator .unlist {
+    border-bottom: 3px dashed #ddd;
+padding-bottom: 15px;
+}
+.block_forum_aggregator .unlist:last-child {
+    border: none;
+}
-- 
1.7.10.4

