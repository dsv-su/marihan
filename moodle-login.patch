From abf206bc9aec80b4ae45147fe885527024db6617 Mon Sep 17 00:00:00 2001
From: Pavel Sokolov <pavel.m.sokolov@gmail.com>
Date: Mon, 15 May 2017 15:19:41 +0200
Subject: [PATCH] Fix login functions to introduce needed variables for new
 login page

---
 auth/classes/output/login.php | 4 +++-
 login/index.php               | 1 +
 2 files changed, 4 insertions(+), 1 deletion(-)

diff --git a/auth/classes/output/login.php b/auth/classes/output/login.php
index 8bdf91de9e..614734ca17 100644
--- a/auth/classes/output/login.php
+++ b/auth/classes/output/login.php
@@ -116,6 +116,7 @@ class login implements renderable, templatable {
     }
 
     public function export_for_template(renderer_base $output) {
+        global $CFG;
 
         $identityproviders = \auth_plugin_base::prepare_identity_providers_for_output($this->identityproviders, $output);
 
@@ -131,9 +132,10 @@ class login implements renderable, templatable {
         $data->hasinstructions = !empty($this->instructions) || $this->cansignup;
         $data->identityproviders = $identityproviders;
         list($data->instructions, $data->instructionsformat) = external_format_text($this->instructions, FORMAT_MOODLE,
-            context_system::instance()->id);
+            context_system::instance()->id, null, null, null, array('noclean' => true));
         $data->loginurl = $this->loginurl->out(false);
         $data->rememberusername = $this->rememberusername;
+        $data->shibbolethauth = new moodle_url($CFG->httpswwwroot . '/auth/shibboleth');
         $data->signupurl = $this->signupurl->out(false);
         $data->username = $this->username;
 
diff --git a/login/index.php b/login/index.php
index dec075c3c2..f3a52beef6 100644
--- a/login/index.php
+++ b/login/index.php
@@ -45,6 +45,7 @@ if ($cancel) {
 
 //HTTPS is required in this page when $CFG->loginhttps enabled
 $PAGE->https_required();
+$PAGE->requires->jquery();
 
 $context = context_system::instance();
 $PAGE->set_url("$CFG->httpswwwroot/login/index.php");
-- 
2.11.0 (Apple Git-81)

